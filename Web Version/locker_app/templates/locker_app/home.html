{% extends 'locker_app/base.html' %}
{% load static %}

{% block title %}Secure Your Files - File Locker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'locker_app/css/home.css' %}">
{% endblock %}

{% block content %}
<div class="hero-section">
    <h1 class="hero-title">Secure File Encryption</h1>
    <p class="hero-text">Protect your sensitive data with military-grade encryption. Upload, encrypt, and download
        securely.</p>
</div>

<div class="locker-grid">
    {% if user.is_authenticated %}
    <div class="glass-panel locker-card">
        <form method="post" enctype="multipart/form-data" id="lockerForm">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="alert alert-error">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <div class="instructions-panel"
                style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                <h3 style="margin-top: 0; font-size: 1rem; color: var(--primary-color); margin-bottom: 0.5rem;">How to
                    Upload</h3>
                <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-muted);">
                    <li style="margin-bottom: 0.25rem;"><strong>Single/Multiple Files:</strong> Drag & drop into the box
                        below or click to select.</li>
                    <li style="margin-bottom: 0.25rem;"><strong>Entire Folder:</strong> Click the "upload a folder" link
                        inside the box.</li>
                    <li><strong>Encryption Key:</strong> Remember your key! You cannot decrypt files without it.</li>
                </ul>
            </div>

            <!-- File Upload Zone -->
            <div class="form-group">
                <div class="file-upload-zone" id="dropZone">
                    <div class="upload-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <div class="upload-text">Click to upload files or drag and drop</div>
                    <div class="upload-hint">
                        <a href="#" id="folderUploadLink"
                            style="color: var(--primary-color); text-decoration: underline; font-size: 0.9rem;">Click
                            here to upload a folder</a>
                        <br>
                        Drag and drop files here or click to select
                    </div>
                    <div id="fileList" style="margin-top: 1rem; font-size: 0.9rem; color: var(--primary-color);"></div>
                    <button type="button" id="clearFilesBtn" class="btn btn-outline"
                        style="display: none; margin-top: 1rem; border-color: #ef4444; color: #ef4444;">
                        Clear Selection
                    </button>
                </div>
                {{ form.file }}
                {{ form.folder }}
                {{ form.folder_name }}
                <style>
                    #id_folder {
                        display: none;
                    }
                </style>
                <script>
                    document.getElementById('dropZone').addEventListener('click', function (e) {
                        if (e.target.id !== 'clearFilesBtn' && e.target.id !== 'folderUploadLink') {
                            document.getElementById('id_file').click();
                        }
                    });

                    document.getElementById('folderUploadLink').addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        document.getElementById('id_folder').click();
                    });

                    document.getElementById('id_folder').addEventListener('change', function (e) {
                        if (this.files.length > 0) {
                            // Extract folder name from the first file's relative path
                            // webkitRelativePath format: "FolderName/FileName.ext"
                            const relativePath = this.files[0].webkitRelativePath;
                            if (relativePath) {
                                const folderName = relativePath.split('/')[0];
                                document.getElementById('id_folder_name').value = folderName;
                            }
                        }
                    });
                </script>
                {% if form.file.errors %}
                <div class="alert alert-error" style="margin-top: 0.5rem;">{{ form.file.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="options-grid">
                <!-- Algorithm Selection -->
                <div class="option-group">
                    <label class="option-label">Encryption Algorithm</label>
                    {{ form.algorithm }}
                </div>

                <!-- Action Selection -->
                <div class="option-group">
                    <label class="option-label">Action</label>
                    <div class="radio-group">
                        {% for radio in form.action %}
                        <div class="radio-option">
                            {{ radio.tag }}
                            <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Key Input -->
            <div class="form-group" style="margin-top: 1.5rem;">
                <label for="{{ form.key.id_for_label }}" class="form-label">Secret Key</label>
                <div style="position: relative;">
                    {{ form.key }}
                    <span id="togglePassword"
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted); padding: 4px; display: flex; align-items: center; justify-content: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="feather feather-eye">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </span>
                    <style>
                        #id_key {
                            padding-right: 40px !important;
                        }
                    </style>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Required for XOR
                    encryption</div>
                {% if form.key.errors %}
                <div class="alert alert-error" style="margin-top: 0.5rem;">{{ form.key.errors.0 }}</div>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary action-btn">Process Files</button>
        </form>
    </div>
    {% else %}
    <div class="glass-panel locker-card" style="text-align: center; padding: 3rem 2rem;">
        <div style="margin-bottom: 2rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                style="color: var(--primary-color); margin: 0 auto;">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        </div>
        <h2 style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--text-color);">Secure Your Files</h2>
        <p
            style="color: var(--text-muted); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
            Please sign in or create an account to start encrypting and decrypting your files with military-grade
            security.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="{% url 'login' %}" class="btn btn-primary" style="padding: 0.75rem 2rem;">Sign In</a>
            <a href="{% url 'signup' %}" class="btn btn-outline" style="padding: 0.75rem 2rem;">Create Account</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('id_file');
        const folderInput = document.getElementById('id_folder');
        const dropZone = document.getElementById('dropZone');
        const fileList = document.getElementById('fileList');
        const clearFilesBtn = document.getElementById('clearFilesBtn');
        const lockerForm = document.getElementById('lockerForm');

        if (lockerForm) {
            lockerForm.addEventListener('submit', function (e) {
                const fileCount = fileInput ? fileInput.files.length : 0;
                const folderCount = folderInput ? folderInput.files.length : 0;
                // alert(`DEBUG: Submitting form. Files: ${fileCount}, Folder files: ${folderCount}`);
            });
        }

        function handleFiles(files) {
            updateFileList(files);
        }

        // Handle file selection
        if (fileInput) {
            fileInput.addEventListener('change', function (e) {
                handleFiles(this.files);
            });
        }

        if (folderInput) {
            folderInput.addEventListener('change', function (e) {
                handleFiles(this.files);
            });
        }

        // Drag and drop effects
        let dragCounter = 0;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropZone.addEventListener('dragenter', function (e) {
            dragCounter++;
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', function (e) {
            dragCounter--;
            if (dragCounter <= 0) {
                dragCounter = 0;
                dropZone.classList.remove('drag-over');
            }
        });

        dropZone.addEventListener('drop', function (e) {
            dragCounter = 0;
            dropZone.classList.remove('drag-over');

            const dt = e.dataTransfer;
            const files = dt.files;

            // For drag and drop, we'll use the file input
            if (fileInput) {
                fileInput.files = files;
                handleFiles(files);
            }
        });

        function updateFileList(files) {
            if (files.length > 0) {
                // Show first few files
                const maxDisplay = 3;
                let names = Array.from(files).slice(0, maxDisplay).map(f => f.name).join(', ');
                if (files.length > maxDisplay) {
                    names += `, and ${files.length - maxDisplay} more`;
                }

                fileList.textContent = `Selected: ${names}`;
                document.querySelector('.upload-text').textContent = `${files.length} item(s) selected`;
                if (clearFilesBtn) clearFilesBtn.style.display = 'inline-block';
            } else {
                fileList.textContent = '';
                document.querySelector('.upload-text').textContent = 'Click to upload files or drag and drop';
                if (clearFilesBtn) clearFilesBtn.style.display = 'none';
            }
        }

        if (clearFilesBtn) {
            clearFilesBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                if (fileInput) fileInput.value = '';
                if (folderInput) folderInput.value = '';
                updateFileList([]);
            });
        }

        // Password visibility toggle
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('id_key');

        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', function (e) {
                // toggle the type attribute
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);

                // toggle the eye icon
                if (type === 'text') {
                    this.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;
                } else {
                    this.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
                }
            });
        }
    });
</script>
{% endblock %}